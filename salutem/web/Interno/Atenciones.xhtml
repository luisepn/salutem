<?xml version='1.0' encoding='UTF-8' ?>
<!--
    Documento   : Atenciones
    Fecha       : 24 de Agosto de 2018, 15:46:28 PM
    Author      : Luis Fernando Ordóñez Armijos
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ace="http://www.icefaces.org/icefaces/components"
      xmlns:c="http://java.sun.com/jsp/jstl/core">
    <h:body>
        <h:form>
            <ui:composition template="../plantillas/Plantilla.xhtml">
                <ui:define name="content">
                    <ace:panel id="panel"
                               header="#{salutemAtenciones.perfil.menu.nombre}"
                               closable="false"
                               toggleable="true">
                        <h:panelGrid columns="2">    
                            <h:panelGrid>
                                <h:panelGrid columns="2">
                                    <h:outputLabel value="Especialidad: " styleClass="bold"/>
                                    <h:selectOneMenu value="#{salutemCombos.especialidad}">
                                        <f:selectItems value="#{salutemCombos.especialidades}"/>
                                        <ace:ajax execute="@all"/>
                                    </h:selectOneMenu>
                                    <h:outputLabel value="Profesional: " styleClass="bold"/>
                                    <h:selectOneMenu value="#{salutemCombos.profesional}" disabled="#{salutemSeguridad.profesional ne null}">
                                        <f:selectItems value="#{salutemCombos.profesionales}"/>
                                        <ace:ajax execute="@all"/>
                                    </h:selectOneMenu>
                                    <h:outputLabel value="¿Con cita?: " styleClass="bold"/>
                                    <h:selectBooleanCheckbox value="#{salutemAtenciones.conCita}">
                                        <ace:ajax execute="@all"/>
                                    </h:selectBooleanCheckbox>
                                    <h:panelGroup>
                                        <h:outputLabel value="Citas: " styleClass="bold" rendered="#{salutemAtenciones.conCita}"/>
                                        <h:outputText  value="#{salutemSeguridad.fechaActual}">
                                            <f:convertDateTime pattern="#{salutemSeguridad.formatoFechaHora}"/>
                                        </h:outputText>
                                    </h:panelGroup>
                                    <h:selectOneMenu value="#{salutemAtenciones.cita}" rendered="#{salutemAtenciones.conCita}">
                                        <f:selectItems value="#{salutemCombos.citas}"/>
                                    </h:selectOneMenu>
                                </h:panelGrid>
                                <h:panelGrid columns="3" rendered="#{!salutemAtenciones.conCita}">
                                    <h:outputLabel value="Paciente:" />
                                    <h:selectOneMenu value="#{salutemPacientes.parametroBusqueda}">
                                        <f:selectItem itemLabel="Nombres" itemValue="o.persona.nombres"/>
                                        <f:selectItem itemLabel="Apellidos" itemValue="o.persona.apellidos"/>
                                        <f:selectItem itemLabel="Cédula" itemValue="o.persona.cedula"/>
                                        <ace:ajax execute="@all"/>
                                    </h:selectOneMenu>
                                    <ace:autoCompleteEntry 
                                        value="#{salutemPacientes.claveBusqueda}"
                                        width="400"
                                        listVar="itemPaciente"
                                        filterBy="#{salutemPacientes.parametroBusqueda 
                                                    eq 'o.persona.apellidos' ? itemPaciente.toStringApellidos() :
                                                    salutemPacientes.parametroBusqueda eq 'o.persona.nombres' ?
                                                    itemPaciente.toStringNombres() : itemPaciente.toStringCedula()}"
                                        filterMatchMode="none"
                                        listValue="#{salutemPacientes.listaPacientes}"
                                        valueChangeListener="#{salutemPacientes.cambiaPacientes}"
                                        textChangeListener="#{salutemPacientes.pacientesChangeEventHandler}"
                                        labelPosition="left">
                                        <f:facet name="row">
                                            <h:panelGrid columns="3" width="100%" columnClasses="tipo">
                                                <h:outputText value="#{itemPaciente.persona.apellidos}"/>
                                                <h:outputText value="#{itemPaciente.persona.nombres}"/>
                                                <h:outputText value="#{itemPaciente.persona.cedula}"/>
                                            </h:panelGrid>
                                        </f:facet>
                                        <ace:ajax execute="@all"/>
                                    </ace:autoCompleteEntry>
                                    <h:outputLabel/>
                                    <h:outputLabel rendered="#{salutemPacientes.paciente ne null}"/>
                                    <ace:panel rendered="#{salutemPacientes.paciente ne null}">
                                        <h:panelGrid columns="4" width="300">
                                            <h:outputLabel value="Nombres:" for="nombreidca" styleClass="bold" />
                                            <h:outputLabel id="nombreidca" value="#{salutemPacientes.paciente.persona.nombres}" />
                                            <h:outputLabel value="Apellidos:" for="apellidosidca" styleClass="bold" />
                                            <h:outputLabel id="apellidosidca" value="#{salutemPacientes.paciente.persona.apellidos}"  />
                                            <h:outputLabel value="CI:" for="ciidca" styleClass="bold"  />
                                            <h:outputLabel id="ciidca" value="#{salutemPacientes.paciente.persona.cedula}"/>
                                            <h:outputLabel value="Email:" for="emailidca" styleClass="bold"  />
                                            <h:outputLabel id="emailidca" value="#{salutemPacientes.paciente.persona.email}"/>
                                        </h:panelGrid>
                                    </ace:panel>
                                </h:panelGrid>


                                <h:panelGrid columns="2" rendered="#{!salutemAtenciones.formulario.mostrar}" >
                                    <ace:menuBar autoSubmenuDisplay="true" >
                                        <ace:menuItem value="Buscar" icon="ui-icon ui-icon-search"  action="#{salutemAtenciones.buscar()}"/>
                                        <ace:menuItem value="Crear" icon="ui-icon ui-icon-document"  action="#{salutemAtenciones.insertar()}"/>
                                    </ace:menuBar>
                                    <ace:messages style="white-space: pre-wrap"/>
                                </h:panelGrid>
                            </h:panelGrid>
                        </h:panelGrid>
                    </ace:panel>
                    <ace:panel 
                        header="Resultado Búsqueda"
                        closable="false"
                        toggleable="true">
                        <h:panelGrid columns="3" styleClass="centeredPanelGrid">
                            <h:outputLabel  value="Exportar a:"/>
                            <h:selectOneRadio  value="#{salutemAtenciones.formulario.tipo}" required="true">
                                <f:ajax disabled="false"/>
                                <f:selectItem itemValue="csv" itemLabel="CSV"/>
                                <f:selectItem itemValue="xls" itemLabel="XLS"/>
                                <f:selectItem itemValue="xml" itemLabel="XML"/>
                            </h:selectOneRadio>
                            <ace:dataExporter id="dataExporter" 
                                              label="Exportar Archivo" 
                                              type="#{salutemAtenciones.formulario.tipo}" 
                                              target="tabla" 
                                              fileName="#{salutemSeguridad.titulo}"
                                              excludeColumns="1"/>
                        </h:panelGrid>
                        <h:panelGrid width="100%">
                            <ace:dataTable id="tabla"
                                           lazy="true"
                                           paginatorAlwaysVisible="true"
                                           value="#{salutemAtenciones.atenciones}"
                                           var="item"
                                           paginator="true"
                                           rowIndexVar="row"
                                           paginatorPosition="both"
                                           rowsPerPageTemplate="#{salutemAtenciones.formulario.rowsPerPageTemplate}"
                                           currentPageReportTemplate="{totalRecords} Registro(s). Página {currentPage} de {totalPages}"
                                           paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                           rows="50">
                                <ace:tableConfigPanel 
                                    dragHandle=".ui-tableconf-header"
                                    columnNameConfigurable="true"
                                    columnVisibilityConfigurable="true"
                                    columnOrderingConfigurable="true"
                                    columnSortingConfigurable="true"
                                    modal="true"/>
                                <ace:column headerText="Registro" style="text-align: right; width: 50px;">
                                    <h:outputText value="#{row+1}"/>
                                </ace:column>
                                <ace:column headerText="Operaciones" style="text-align: left; width: 50px;">
                                    <ace:menuButton  effect="slide" effectDuration="200" value="..." >
                                        <ace:menuItem action="#{salutemAtenciones.editar()}" value="Editar" icon="ui-icon ui-icon-pencil"/>
                                        <ace:menuItem action="#{salutemAtenciones.eliminar()}" value="Borrar" icon="ui-icon ui-icon-trash"/>
                                        <ace:menuItem action="#{salutemAtenciones.imprimir()}" value="Imprimir" icon="ui-icon ui-icon-print"/>
                                        <ace:menuItem action="#{salutemHistorial.buscar(salutemAtenciones.nombreTabla, item.id)}" value="Historial" icon="ui-icon ui-icon-script"/>
                                    </ace:menuButton>
                                </ace:column> 
                                <ace:column  headerText="Fecha" sortBy="#{item.fecha}" 
                                             filterBy="#{item.fecha}" 
                                             filterDatePattern="dd/MM/yyyy HH:mm"
                                             filterValueMin="#{salutemAtenciones.fechaInicio}"
                                             filterValueMax="#{salutemAtenciones.fechaFin}"
                                             type="DATE"
                                             rangedFilter="true" 
                                             style="text-align: left">
                                    <h:outputText  value="#{item.fecha}">
                                        <f:convertDateTime pattern="#{salutemSeguridad.formatoFechaHora}"/>
                                    </h:outputText>
                                </ace:column>
                                <ace:column  headerText="Paciente" sortBy="#{item.paciente.persona.apellidos}" style="text-align: left" 
                                             filterBy="#{item.paciente.persona.apellidos}" filterMatchMode="contains">
                                    <h:outputText  value="#{item.paciente.toString()}"/>
                                </ace:column>
                                <ace:column  headerText="Especialidad" sortBy="#{item.especialidad.nombre}" style="text-align: left" 
                                             filterBy="#{item.especialidad.nombre}" filterMatchMode="contains">
                                    <h:outputText  value="#{item.especialidad.nombre}"/>
                                </ace:column>
                                <ace:column  headerText="Profesional" sortBy="#{item.profesional.persona.apellidos}" style="text-align: left" 
                                             filterBy="#{item.profesional.persona.apellidos}" filterMatchMode="contains">
                                    <h:outputText  value="#{item.profesional.toString()}"/>
                                </ace:column>
                                <ace:column  headerText="Motivo" sortBy="#{item.motivo}" filterBy="#{item.motivo}" filterMatchMode="contains" style="text-align: left">
                                    <h:outputText  value="#{item.motivo}"/>
                                </ace:column>
                                <ace:column  headerText="Dignóstico" sortBy="#{item.diagnostico}" filterBy="#{item.diagnostico}" filterMatchMode="contains" style="text-align: left">
                                    <h:outputText  value="#{item.diagnostico}"/>
                                </ace:column>
                                <ace:column  headerText="Observaciones" sortBy="#{item.observaciones}" filterBy="#{item.observaciones}" filterMatchMode="contains" style="text-align: left">
                                    <h:outputText  value="#{item.observaciones}"/>
                                </ace:column>
                                <ace:column  headerText="Creación" sortBy="#{item.creado}" 
                                             filterBy="#{item.creado}" 
                                             filterDatePattern="dd/MM/yyyy HH:mm"
                                             filterValueMin="#{salutemSeguridad.inicioCreado}"
                                             filterValueMax="#{salutemSeguridad.finCreado}"
                                             type="DATE"
                                             rangedFilter="true" 
                                             style="text-align: left" rendered="false">
                                    <h:outputText  value="#{item.creado}">
                                        <f:convertDateTime pattern="#{salutemSeguridad.formatoFechaHora}"/>
                                    </h:outputText>
                                </ace:column>
                                <ace:column  headerText="Creador por" sortBy="#{item.creadopor}" filterBy="#{item.creadopor}" filterMatchMode="contains" style="text-align: left" rendered="false">
                                    <h:outputText  value="#{item.creadopor}"/>
                                </ace:column>
                                <ace:column  headerText="Modificado" sortBy="#{item.actualizado}" 
                                             filterBy="#{item.actualizado}" 
                                             filterDatePattern="dd/MM/yyyy HH:mm"
                                             filterValueMin="#{salutemSeguridad.inicioActualizado}"
                                             filterValueMax="#{salutemSeguridad.finActualizado}"
                                             type="DATE"
                                             rangedFilter="true" 
                                             style="text-align: left" rendered="false">
                                    <h:outputText  value="#{item.actualizado}">
                                        <f:convertDateTime pattern="#{salutemSeguridad.formatoFechaHora}"/>
                                    </h:outputText>
                                </ace:column>
                                <ace:column  headerText="Modificado por" sortBy="#{item.actualizado}" filterBy="#{item.actualizado}" filterMatchMode="contains" style="text-align: left" rendered="false">
                                    <h:outputText  value="#{item.actualizadopor}"/>
                                </ace:column>
                            </ace:dataTable>
                        </h:panelGrid>                        
                    </ace:panel>

                    <ace:dialog 
                        header="#{salutemAtenciones.perfil.menu.nombre}"
                        closable="false"
                        modal="true"
                        draggable="true"
                        showEffect="clip"
                        hideEffect="fade"
                        maximizableRestorable="true"
                        zindex="10"
                        rendered="#{salutemAtenciones.formulario.mostrar}"
                        visible="#{salutemAtenciones.formulario.mostrar}">
                        <ace:tabSet style="width: 100%">
                            <ace:tabPane label="#{salutemSeguridad.getFechaConFormato(salutemAtenciones.atencion.fecha)}" rendered="#{salutemAtenciones.atencion ne null}">
                                <h:panelGrid columns="2" width="100%" columnClasses="cuarenta, sesenta">

                                    <h:panelGrid width="100%">
                                        <ace:panel header="Optometría" rendered="#{salutemAtenciones.atencion.especialidad.codigo eq 'OPT'}">
                                            <ace:menuBar autoSubmenuDisplay="true">
                                                <ace:menuItem value="Grabar" icon="ui-icon ui-icon-disk" 
                                                              action="#{salutemAtenciones.grabarFormula()}"/>
                                            </ace:menuBar>
                                            <h:panelGrid columns="3" width="100%">
                                                <ace:panel header="LENSOMETRÍA">
                                                    <h:panelGrid columns="2">
                                                        <h:outputText value="OD" styleClass="bold"/>
                                                        <ace:textEntry value="#{salutemAtenciones.lensometria.d}" title="Ojo derecho" style="width: 50px"/>
                                                        <h:outputText value="OI" styleClass="bold"/>
                                                        <ace:textEntry value="#{salutemAtenciones.lensometria.i}" title="Ojo izquierdo" style="width: 50px"/>
                                                    </h:panelGrid>                              
                                                </ace:panel>

                                                <ace:panel header="AV SC">
                                                    <h:panelGrid columns="2">
                                                        <h:outputText value="OD" styleClass="bold"/>
                                                        <ace:textEntry value="#{salutemAtenciones.agudezavisualsincristal.d}" title="Ojo derecho" style="width: 50px"/>
                                                        <h:outputText value="OI" styleClass="bold"/>
                                                        <ace:textEntry value="#{salutemAtenciones.agudezavisualsincristal.i}" title="Ojo izquierdo" style="width: 50px"/>
                                                    </h:panelGrid>                              
                                                </ace:panel>

                                                <ace:panel header="AV CC">
                                                    <h:panelGrid columns="2">
                                                        <h:outputText value="OD" styleClass="bold"/>
                                                        <ace:textEntry value="#{salutemAtenciones.agudezavisualconcristal.d}" title="Ojo derecho" style="width: 50px"/>
                                                        <h:outputText value="OI" styleClass="bold"/>
                                                        <ace:textEntry value="#{salutemAtenciones.agudezavisualconcristal.i}" title="Ojo izquierdo" style="width: 50px"/>
                                                    </h:panelGrid>                              
                                                </ace:panel>
                                            </h:panelGrid>
                                            <h:panelGrid width="100%">
                                                <ace:dataTable
                                                    value="#{salutemAtenciones.listaRxFinal}"
                                                    resizableColumns="true"
                                                    var="rxfinal">
                                                    <f:facet name="header">Rx Final</f:facet>
                                                    <ace:column headerText="" style="text-align: center">
                                                        <h:outputText value="#{rxfinal.ojo}" style="width: 50px"/>
                                                    </ace:column>
                                                    <ace:column headerText="Esfera" style="text-align: center">
                                                        <ace:textEntry value="#{rxfinal.esfera}" style="width: 50px"/>
                                                    </ace:column>
                                                    <ace:column headerText="Cilindro" style="text-align: center">
                                                        <ace:textEntry value="#{rxfinal.cilindro}" style="width: 50px"/>
                                                    </ace:column>
                                                    <ace:column headerText="Eje" style="text-align: center">
                                                        <ace:textEntry value="#{rxfinal.eje}" style="width: 50px"/>
                                                    </ace:column>
                                                    <ace:column headerText="ADD" style="text-align: center">
                                                        <ace:textEntry value="#{rxfinal.adicion}" style="width: 50px"/>
                                                    </ace:column>
                                                    <ace:column headerText="DP" style="text-align: center">
                                                        <ace:textEntry value="#{rxfinal.distanciapupilar}" style="width: 50px"/>
                                                    </ace:column>
                                                    <ace:column headerText="AV" style="text-align: center">
                                                        <ace:textEntry value="#{rxfinal.agudezavisual}" style="width: 50px"/>
                                                    </ace:column>
                                                </ace:dataTable>
                                            </h:panelGrid>
                                        </ace:panel>
                                        <ace:panel header="Ficha médica" rendered="#{salutemDatos.datos.size() gt 0}">
                                            <h:panelGrid width="100%">
                                                <ui:include src="../cuadroDatos.xhtml"/>                                       
                                            </h:panelGrid>
                                        </ace:panel>

                                    </h:panelGrid>

                                    <h:panelGrid width="100%">
                                        <ace:panel header="Datos del Paciente">
                                            <h:panelGrid columns="2">
                                                <h:outputLabel value="C.I.:" styleClass="bold"/>
                                                <h:outputLabel value="#{salutemAtenciones.atencion.paciente.persona.cedula}"/>
                                                <h:outputLabel value="Nombres:" styleClass="bold"/>
                                                <h:outputLabel value="#{salutemAtenciones.atencion.paciente.persona.nombres}"/>
                                                <h:outputLabel value="Apellidos:" styleClass="bold"/>
                                                <h:outputLabel value="#{salutemAtenciones.atencion.paciente.persona.apellidos}"/>
                                                <h:outputLabel value="E-mail:" styleClass="bold"/>
                                                <h:outputLabel value="#{salutemAtenciones.atencion.paciente.persona.email}"/>
                                                <h:outputLabel value="Fecha de Nacimiento:" styleClass="bold"/>
                                                <h:outputLabel value="#{salutemAtenciones.atencion.paciente.persona.fecha}">
                                                    <f:convertDateTime pattern="#{salutemSeguridad.formatoFecha}"/>   
                                                </h:outputLabel>
                                                <h:outputLabel value="Ocupación:" styleClass="bold"/>
                                                <h:outputLabel value="#{salutemAtenciones.atencion.paciente.persona.ocupacion}"/>
                                                <h:outputLabel value="Género:" styleClass="bold"/>
                                                <h:outputLabel value="#{salutemAtenciones.atencion.paciente.persona.genero.nombre}"/>
                                                <h:outputLabel value="Descripción:" styleClass="bold"/>
                                                <h:outputLabel value="#{salutemAtenciones.atencion.paciente.descripcion}" style="white-space: pre-wrap"/>
                                            </h:panelGrid>
                                        </ace:panel>

                                        <ace:panel header="Prescripción" rendered="#{salutemAtenciones.atencion.especialidad.codigo ne 'OPT'}">
                                            <h:panelGrid width="100%">
                                                <ace:menuBar autoSubmenuDisplay="true" rendered="#{!salutemAtenciones.formulario.eliminar}">
                                                    <ace:menuItem value="Nueva" icon="ui-icon ui-icon-document" 
                                                                  action="#{salutemAtenciones.crearPrescripcion()}"/>
                                                    <ace:menuItem value="Grabar" icon="ui-icon ui-icon-disk" 
                                                                  action="#{salutemAtenciones.grabarPrescripciones()}"
                                                                  rendered="#{salutemAtenciones.prescripciones.size() gt 0}"/>
                                                </ace:menuBar>
                                                <ace:dataTable
                                                    value="#{salutemAtenciones.prescripciones}"
                                                    resizableColumns="true"
                                                    var="prescripcion"                                                    
                                                    binding="#{bprescripcion}">
                                                    <f:facet name="header">Prescripciones</f:facet>
                                                    <ace:column headerText="Operaciones" style="text-align: left">
                                                        <h:commandLink value="Eliminar" action="#{salutemAtenciones.eliminarPrescripcion(bprescripcion.rowIndex)}"/>
                                                    </ace:column>
                                                    <ace:column headerText="Medicamento" style="text-align: left">
                                                        <ace:textAreaEntry value="#{prescripcion.medicamento}" rows="1"/>
                                                    </ace:column>
                                                    <ace:column headerText="Dosis" style="text-align: left">
                                                        <ace:textAreaEntry value="#{prescripcion.dosis}" rows="1"/>
                                                    </ace:column>
                                                    <ace:column headerText="Frecuencia" style="text-align: left">
                                                        <ace:textAreaEntry value="#{prescripcion.frecuencia}" rows="1"/>
                                                    </ace:column>
                                                    <ace:column headerText="Duración" style="text-align: left">
                                                        <ace:textAreaEntry value="#{prescripcion.duracion}" rows="1"/>
                                                    </ace:column>
                                                    <ace:column headerText="Advertencias" style="text-align: left">
                                                        <ace:textAreaEntry value="#{prescripcion.advertencias}" rows="1"/>
                                                    </ace:column>
                                                </ace:dataTable>
                                            </h:panelGrid>
                                        </ace:panel>
                                        <ace:panel header="Orden de Laboratorio" rendered="#{salutemAtenciones.atencion.especialidad.codigo eq 'OPT'}">
                                            <h:panelGrid width="100%">
                                                <h:panelGrid columns="2" rendered="#{salutemAtenciones.orden eq null or salutemAtenciones.orden.id eq null}">
                                                    <h:outputLabel value="Laboratorio" styleClass="bold"/>
                                                    <h:selectOneMenu value="#{salutemAtenciones.laboratorio}">
                                                        <f:selectItems value="#{salutemCombos.laboratorios}" />
                                                    </h:selectOneMenu>
                                                </h:panelGrid>
                                                <h:panelGrid columns="2" rendered="#{salutemAtenciones.orden ne null and salutemAtenciones.orden.id ne null}">
                                                    <h:outputLabel value="Laboratorio" styleClass="bold"/>
                                                    <h:selectOneMenu value="#{salutemAtenciones.orden.laboratorio}">
                                                        <f:selectItems value="#{salutemCombos.laboratorios}" />
                                                    </h:selectOneMenu>
                                                    <h:outputLabel value="Fcatura:" styleClass="bold"/>
                                                    <ace:textEntry value="#{salutemAtenciones.orden.factura}"/>  
                                                </h:panelGrid>
                                                <ace:menuBar autoSubmenuDisplay="true" rendered="#{!salutemAtenciones.formulario.eliminar}">
                                                    <ace:menuItem value="Generar" icon="ui-icon ui-icon-script" 
                                                                  action="#{salutemAtenciones.crearOrden()}" 
                                                                  rendered="#{salutemAtenciones.orden eq null or salutemAtenciones.orden.id eq null}"/>
                                                    <ace:menuItem value="Grabar" icon="ui-icon ui-icon-disk" 
                                                                  action="#{salutemAtenciones.grabarOrden()}"
                                                                  rendered="#{salutemAtenciones.orden ne null and salutemAtenciones.orden.id ne null}"/>/>
                                                </ace:menuBar>
                                                <ace:dataTable
                                                    value="#{salutemAtenciones.listaRxFinal}"
                                                    resizableColumns="true"
                                                    var="rxorden">
                                                    <f:facet name="header">Laboratorio: #{salutemAtenciones.orden.laboratorio}</f:facet>
                                                    <ace:column headerText="" style="text-align: center">
                                                        <h:outputText value="#{rxorden.ojo}"/>
                                                    </ace:column>
                                                    <ace:column headerText="Esfera" style="text-align: center">
                                                        <h:outputText value="#{rxorden.esfera}"/>
                                                    </ace:column>
                                                    <ace:column headerText="Cilindro" style="text-align: center">
                                                        <h:outputText value="#{rxorden.cilindro}"/>
                                                    </ace:column>
                                                    <ace:column headerText="Eje" style="text-align: center">
                                                        <h:outputText value="#{rxorden.eje}"/>
                                                    </ace:column>
                                                    <ace:column headerText="ADD" style="text-align: center">
                                                        <h:outputText value="#{rxorden.adicion}"/>
                                                    </ace:column>
                                                    <ace:column headerText="DP" style="text-align: center">
                                                        <h:outputText value="#{rxorden.distanciapupilar}"/>
                                                    </ace:column>
                                                    <ace:column headerText="AV" style="text-align: center">
                                                        <h:outputText value="#{rxorden.agudezavisual}"/>
                                                    </ace:column>
                                                </ace:dataTable>
                                            </h:panelGrid>
                                        </ace:panel>
                                    </h:panelGrid>

                                </h:panelGrid>
                                <ace:panel header="Atención" style="width: 100%">
                                    <h:panelGrid columns="2" width="100%">
                                        <h:outputText value="Motivo:" styleClass="bold"/>
                                        <h:inputTextarea cols="150" rows="4" value="#{salutemAtenciones.atencion.motivo}" style="width: 99%"/>
                                        <h:outputText value="Diagnostico:" styleClass="bold"/>
                                        <h:inputTextarea cols="150" rows="4" value="#{salutemAtenciones.atencion.diagnostico}" style="width: 99%"/>
                                        <h:outputText value="Observaciones:" styleClass="bold"/>
                                        <h:inputTextarea cols="150" rows="4" value="#{salutemAtenciones.atencion.observaciones}" style="width: 99%"/>
                                    </h:panelGrid>
                                </ace:panel>
                            </ace:tabPane>
                            <ace:tabPane label="#{salutemSeguridad.getFechaConFormato(salutemAtenciones.ultimaAtencion.fecha)}" rendered="#{salutemAtenciones.ultimaAtencion ne null}">
                                <h:panelGrid width="100%" rendered="#{salutemAtenciones.verHistorico}">
                                    <h:panelGrid columns="4" styleClass="centeredPanelGrid">
                                        <h:outputLabel  value="Exportar a:"/>
                                        <h:selectOneRadio  value="#{salutemAtenciones.formulario.tipo}" required="true">
                                            <f:ajax disabled="false"/>
                                            <f:selectItem itemValue="csv" itemLabel="CSV"/>
                                            <f:selectItem itemValue="xls" itemLabel="XLS"/>
                                            <f:selectItem itemValue="xml" itemLabel="XML"/>
                                        </h:selectOneRadio>
                                        <ace:dataExporter id="dataExportera" 
                                                          label="Exportar Archivo" 
                                                          type="#{salutemAtenciones.formulario.tipo}" 
                                                          target="tablaa" 
                                                          fileName="#{salutemSeguridad.titulo}"
                                                          excludeColumns="1"/>
                                        <ace:menuBar autoSubmenuDisplay="true" >
                                            <ace:menuItem value="Ver Último" icon="ui-icon ui-icon-search"  action="#{salutemAtenciones.buscarUltimaAtencion()}"/>
                                        </ace:menuBar>
                                    </h:panelGrid>                                    
                                    <h:panelGrid width="100%">
                                        <ace:dataTable id="tablaa"
                                                       lazy="true"
                                                       paginatorAlwaysVisible="true"
                                                       value="#{salutemAtenciones.atenciones}"
                                                       var="itema"
                                                       paginator="true"
                                                       rowIndexVar="row"
                                                       paginatorPosition="both"
                                                       rowsPerPageTemplate="#{salutemAtenciones.formulario.rowsPerPageTemplate}"
                                                       currentPageReportTemplate="{totalRecords} Registro(s). Página {currentPage} de {totalPages}"
                                                       paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                                       rows="50">
                                            <ace:column headerText="Registro" style="text-align: right; width: 50px;">
                                                <h:outputText value="#{row+1}"/>
                                            </ace:column>
                                            <ace:column headerText="Operaciones" style="text-align: left; width: 50px;">
                                                <ace:menuBar autoSubmenuDisplay="true" >
                                                    <ace:menuItem value="Ver" icon="ui-icon ui-icon-search"  action="#{salutemAtenciones.colocarUltimaAtencion(itema)}"/>
                                                </ace:menuBar>
                                            </ace:column> 
                                            <ace:column  headerText="Fecha" sortBy="#{itema.fecha}" 
                                                         filterBy="#{itema.fecha}" 
                                                         filterDatePattern="dd/MM/yyyy HH:mm"
                                                         filterValueMin="#{salutemAtenciones.fechaInicio}"
                                                         filterValueMax="#{salutemAtenciones.fechaFin}"
                                                         type="DATE"
                                                         rangedFilter="true" 
                                                         style="text-align: left">
                                                <h:outputText  value="#{itema.fecha}">
                                                    <f:convertDateTime pattern="#{salutemSeguridad.formatoFechaHora}"/>
                                                </h:outputText>
                                            </ace:column>
                                            <ace:column  headerText="Profesional" sortBy="#{itema.profesional.persona.apellidos}" style="text-align: left" 
                                                         filterBy="#{itema.profesional.persona.apellidos}" filterMatchMode="contains">
                                                <h:outputText  value="#{itema.profesional.toString()}"/>
                                            </ace:column>
                                            <ace:column  headerText="Motivo" sortBy="#{itema.motivo}" filterBy="#{itema.motivo}" filterMatchMode="contains" style="text-align: left">
                                                <h:outputText  value="#{itema.motivo}"/>
                                            </ace:column>
                                            <ace:column  headerText="Dignóstico" sortBy="#{itema.diagnostico}" filterBy="#{itema.diagnostico}" filterMatchMode="contains" style="text-align: left">
                                                <h:outputText  value="#{itema.diagnostico}"/>
                                            </ace:column>
                                        </ace:dataTable>
                                    </h:panelGrid> 
                                </h:panelGrid> 

                                <h:commandLink value="Imprimir" rendered="#{salutemAtenciones.formulario.imprimir}">
                                    <ace:printer for="imprimir"/>
                                </h:commandLink>

                                <ace:dynamicResource
                                    mimeType="application/pdf"
                                    resource="#{salutemAtenciones.generarConsulta()}"
                                    label="Imprimir"/>

                                <h:panelGrid width="100%" rendered="#{!salutemAtenciones.verHistorico}"  id="imprimir">

                                    <ace:menuBar autoSubmenuDisplay="true" rendered="#{!salutemAtenciones.formulario.eliminar and !salutemAtenciones.formulario.imprimir}">
                                        <ace:menuItem value="Ver Histórico" icon="ui-icon ui-icon-script"  action="#{salutemAtenciones.setVerHistorico(true)}"/>
                                        <ace:menuItem value="Ver Último" icon="ui-icon ui-icon-search"  action="#{salutemAtenciones.buscarUltimaAtencion()}" rendered="#{salutemAtenciones.ultimaAtencion.id ne salutemAtenciones.idUltimaAtencion}"/>
                                    </ace:menuBar>
                                    <h:panelGrid columns="2" width="100%" columnClasses="cuarenta, sesenta" rendered="#{!salutemAtenciones.verHistorico}">
                                        <h:panelGrid width="100%">
                                            <ace:panel header="Ficha médica" rendered="#{salutemAtenciones.ultimosDatos.size() gt 0}">
                                                <h:panelGrid width="100%">
                                                    <ace:dataTable
                                                        value="#{salutemAtenciones.ultimosDatos}"
                                                        resizableColumns="true"
                                                        var="datoa">
                                                        <f:facet name="header">Datos</f:facet>
                                                        <ace:row condition="group" groupBy="#{datoa.grupo}" pos="before" styleClass="grupo">
                                                            <ace:column style="text-align: center" colspan="10">
                                                                <ace:excludeFromExport/>
                                                                <h:outputText value="#{datoa.grupo}" />
                                                            </ace:column>
                                                        </ace:row>
                                                        <ace:column  style="text-align: right">
                                                            <h:outputText value="#{datoa.codigo}"/>
                                                        </ace:column>
                                                        <ace:column  style="text-align: right">
                                                            <h:outputText value="#{datoa.nombre}"/>
                                                        </ace:column>
                                                        <ace:column  style="text-align: left">
                                                            <h:outputText value="#{datoa.booleano ne null ? datoa.booleano ? 'Sí':'No':''}" rendered="#{datoa.tipo.codigo eq 'BOOLEAN'}"/>
                                                            <h:outputText value="#{datoa.entero}" rendered="#{datoa.tipo.codigo eq 'INTEGER'}"/>
                                                            <h:outputText value="#{datoa.decimal}" rendered="#{datoa.tipo.codigo eq 'DOUBLE'}"/>
                                                            <h:outputText value="#{datoa.texto}" rendered="#{datoa.tipo.codigo eq 'TEXT'}" style="white-space: pre-wrap"/>
                                                            <h:outputText value="#{datoa.fecha}">
                                                                <f:convertDateTime pattern="dd/MM/yyyy" />
                                                            </h:outputText>
                                                            <h:outputText value="#{datoa.hora}">
                                                                <f:convertDateTime pattern="HH:mm:ss" />
                                                            </h:outputText>
                                                            <h:outputText value="#{datoa.fechahora}">
                                                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
                                                            </h:outputText>
                                                            <h:outputText value="#{salutemDatos.traerSeleccion(datoa)}" 
                                                                          rendered="#{datoa.tipo.codigo eq 'ONE'
                                                                                      or datoa.tipo.codigo eq 'MANY'
                                                                                      or datoa.tipo.codigo eq 'LIST'}">
                                                            </h:outputText>
                                                            <h:panelGrid columns="2" rendered="#{datoa.tipo.codigo eq 'FILE'}">
                                                                <h:outputText value="#{datoa.archivo.nombre}"
                                                                              rendered="#{datoa.archivo ne null}"/>
                                                                <ace:dynamicResource
                                                                    fileName="#{datoa.archivo.traerNombre()}"
                                                                    mimeType="#{datoa.archivo.tipo}"
                                                                    resource="#{salutemArchivos.traerRecurso(datoa.archivo)}"
                                                                    label="Descargar"
                                                                    rendered="#{datoa.archivo ne null and 
                                                                                datoa.archivo.existeFichero()}"/>
                                                            </h:panelGrid>

                                                        </ace:column>
                                                    </ace:dataTable>                                  
                                                </h:panelGrid>
                                            </ace:panel>
                                            <ace:panel header="Optometría" rendered="#{salutemAtenciones.ultimaAtencion.especialidad.codigo eq 'OPT' and salutemAtenciones.ultimaFormula ne null}">
                                                <h:panelGrid columns="3" width="100%">
                                                    <ace:panel header="LENSOMETRÍA" style="width: 100px">
                                                        <h:panelGrid columns="2">
                                                            <h:outputText value="OD:" styleClass="bold"/>
                                                            <h:outputText value="#{salutemAtenciones.ultimaLensometria.d}" title="Ojo derecho" style="width: 50px"/>
                                                            <h:outputText value="OI:" styleClass="bold"/>
                                                            <h:outputText value="#{salutemAtenciones.ultimaLensometria.i}" title="Ojo izquierdo" style="width: 50px"/>
                                                        </h:panelGrid>                              
                                                    </ace:panel>

                                                    <ace:panel header="AV SC" style="width: 100px">
                                                        <h:panelGrid columns="2">
                                                            <h:outputText value="OD:" styleClass="bold"/>
                                                            <h:outputText value="#{salutemAtenciones.ultimaAgudezavisualsincristal.d}" title="Ojo derecho" style="width: 50px"/>
                                                            <h:outputText value="OI:" styleClass="bold"/>
                                                            <h:outputText value="#{salutemAtenciones.ultimaAgudezavisualsincristal.i}" title="Ojo izquierdo" style="width: 50px"/>
                                                        </h:panelGrid>                              
                                                    </ace:panel>

                                                    <ace:panel header="AV CC" style="width: 100px">
                                                        <h:panelGrid columns="2">
                                                            <h:outputText value="OD:" styleClass="bold"/>
                                                            <h:outputText value="#{salutemAtenciones.ultimaAgudezavisualconcristal.d}" title="Ojo derecho" style="width: 50px"/>
                                                            <h:outputText value="OI:" styleClass="bold"/>
                                                            <h:outputText value="#{salutemAtenciones.ultimaAgudezavisualconcristal.i}" title="Ojo izquierdo" style="width: 50px"/>
                                                        </h:panelGrid>                              
                                                    </ace:panel>
                                                </h:panelGrid>
                                                <h:panelGrid width="100%">
                                                    <ace:dataTable
                                                        value="#{salutemAtenciones.ultimaListaRxFinal}"
                                                        resizableColumns="true"
                                                        var="rxfinala">
                                                        <f:facet name="header">Rx Final</f:facet>
                                                        <ace:column headerText="" style="text-align: center">
                                                            <h:outputText value="#{rxfinala.ojo}" style="width: 50px"/>
                                                        </ace:column>
                                                        <ace:column headerText="Esfera" style="text-align: center">
                                                            <h:outputText value="#{rxfinala.esfera}" style="width: 50px"/>
                                                        </ace:column>
                                                        <ace:column headerText="Cilindro" style="text-align: center">
                                                            <h:outputText value="#{rxfinala.cilindro}" style="width: 50px"/>
                                                        </ace:column>
                                                        <ace:column headerText="Eje" style="text-align: center">
                                                            <h:outputText value="#{rxfinala.eje}" style="width: 50px"/>
                                                        </ace:column>
                                                        <ace:column headerText="ADD" style="text-align: center">
                                                            <h:outputText value="#{rxfinala.adicion}" style="width: 50px"/>
                                                        </ace:column>
                                                        <ace:column headerText="DP" style="text-align: center">
                                                            <h:outputText value="#{rxfinala.distanciapupilar}" style="width: 50px"/>
                                                        </ace:column>
                                                        <ace:column headerText="AV" style="text-align: center">
                                                            <h:outputText value="#{rxfinala.agudezavisual}" style="width: 50px"/>
                                                        </ace:column>
                                                    </ace:dataTable>
                                                </h:panelGrid>
                                            </ace:panel>
                                        </h:panelGrid>  
                                        <h:panelGrid width="100%">
                                            <ace:panel header="Datos del paciente">
                                                <h:panelGrid columns="2">
                                                    <h:outputLabel value="C.I.:" styleClass="bold"/>
                                                    <h:outputLabel value="#{salutemAtenciones.ultimaAtencion.paciente.persona.cedula}"/>
                                                    <h:outputLabel value="Nombres:" styleClass="bold"/>
                                                    <h:outputLabel value="#{salutemAtenciones.ultimaAtencion.paciente.persona.nombres}"/>
                                                    <h:outputLabel value="Apellidos:" styleClass="bold"/>
                                                    <h:outputLabel value="#{salutemAtenciones.ultimaAtencion.paciente.persona.apellidos}"/>
                                                    <h:outputLabel value="E-mail:" styleClass="bold"/>
                                                    <h:outputLabel value="#{salutemAtenciones.ultimaAtencion.paciente.persona.email}"/>
                                                    <h:outputLabel value="Fecha de Nacimiento:" styleClass="bold"/>
                                                    <h:outputLabel value="#{salutemAtenciones.ultimaAtencion.paciente.persona.fecha}">
                                                        <f:convertDateTime pattern="#{salutemSeguridad.formatoFecha}"/>   
                                                    </h:outputLabel>
                                                    <h:outputLabel value="Ocupación:" styleClass="bold"/>
                                                    <h:outputLabel value="#{salutemAtenciones.ultimaAtencion.paciente.persona.ocupacion}"/>
                                                    <h:outputLabel value="Género:" styleClass="bold"/>
                                                    <h:outputLabel value="#{salutemAtenciones.ultimaAtencion.paciente.persona.genero.nombre}"/>
                                                    <h:outputLabel value="Descripción:" styleClass="bold"/>
                                                    <h:outputLabel value="#{salutemAtenciones.ultimaAtencion.paciente.descripcion}" style="white-space: pre-wrap"/>
                                                </h:panelGrid>
                                            </ace:panel>
                                            <ace:panel header="Prescripción" rendered="#{salutemAtenciones.ultimaAtencion.especialidad.codigo ne 'OPT'}">
                                                <h:panelGrid width="100%">
                                                    <ace:dataTable
                                                        value="#{salutemAtenciones.ultimasPrescripciones}"
                                                        resizableColumns="true"
                                                        rowIndexVar="row"
                                                        var="prescripciona">
                                                        <f:facet name="header">Prescripciones</f:facet>
                                                        <ace:column  style="text-align: right">
                                                            <h:outputText value="#{row + 1}"/>
                                                        </ace:column>
                                                        <ace:column  headerText="Medicamento" style="text-align: right">
                                                            <h:outputText value="#{prescripciona.medicamento}" style="white-space: pre-wrap"/>
                                                        </ace:column>
                                                        <ace:column  headerText="Dosis" style="text-align: right">
                                                            <h:outputText value="#{prescripciona.dosis}" style="white-space: pre-wrap"/>
                                                        </ace:column>
                                                        <ace:column  headerText="Frecuencia" style="text-align: right">
                                                            <h:outputText value="#{prescripciona.frecuencia}" style="white-space: pre-wrap"/>
                                                        </ace:column>
                                                        <ace:column  headerText="Duración" style="text-align: right">
                                                            <h:outputText value="#{prescripciona.duracion}" style="white-space: pre-wrap"/>
                                                        </ace:column>
                                                        <ace:column  headerText="Advertencias" style="text-align: right">
                                                            <h:outputText value="#{prescripciona.advertencias}" style="white-space: pre-wrap"/>
                                                        </ace:column>
                                                    </ace:dataTable>
                                                </h:panelGrid>
                                            </ace:panel>

                                            <ace:panel header="Orden de Laboratorio" rendered="#{salutemAtenciones.ultimaAtencion.especialidad.codigo eq 'OPT' and salutemAtenciones.ultimaOrden ne null}">
                                                <ace:dataTable
                                                    value="#{salutemAtenciones.ultimaListaRxFinal}"
                                                    resizableColumns="true"
                                                    var="orden">
                                                    <f:facet name="header">Laboratorio: #{salutemAtenciones.ultimaOrden.laboratorio}; Factura: #{salutemAtenciones.ultimaOrden.factura}</f:facet>
                                                    <ace:column headerText="" style="text-align: center">
                                                        <h:outputText value="#{orden.ojo}"/>
                                                    </ace:column>
                                                    <ace:column headerText="Esfera" style="text-align: center">
                                                        <h:outputText value="#{orden.esfera}"/>
                                                    </ace:column>
                                                    <ace:column headerText="Cilindro" style="text-align: center">
                                                        <h:outputText value="#{orden.cilindro}"/>
                                                    </ace:column>
                                                    <ace:column headerText="Eje" style="text-align: center">
                                                        <h:outputText value="#{orden.eje}"/>
                                                    </ace:column>
                                                    <ace:column headerText="ADD" style="text-align: center">
                                                        <h:outputText value="#{orden.adicion}"/>
                                                    </ace:column>
                                                    <ace:column headerText="DP" style="text-align: center">
                                                        <h:outputText value="#{orden.distanciapupilar}"/>
                                                    </ace:column>
                                                    <ace:column headerText="AV" style="text-align: center">
                                                        <h:outputText value="#{orden.agudezavisual}"/>
                                                    </ace:column>
                                                </ace:dataTable>
                                            </ace:panel>

                                        </h:panelGrid>


                                    </h:panelGrid>
                                    <ace:panel header="Atención">    
                                        <h:panelGrid columns="2" width="100%">
                                            <h:outputText value="Motivo:" styleClass="bold"/>
                                            <h:outputText value="#{salutemAtenciones.ultimaAtencion.motivo}" style="white-space: pre-wrap"/>
                                            <h:outputText value="Diagnostico:" styleClass="bold"/>
                                            <h:outputText value="#{salutemAtenciones.ultimaAtencion.diagnostico}" style="white-space: pre-wrap"/>
                                            <h:outputText value="Observaciones:" styleClass="bold"/>
                                            <h:outputText value="#{salutemAtenciones.ultimaAtencion.observaciones}" style="white-space: pre-wrap"/>
                                        </h:panelGrid>
                                    </ace:panel>
                                </h:panelGrid>
                            </ace:tabPane>
                        </ace:tabSet>                        
                        <h:panelGrid columns="2">
                            <ace:menuBar autoSubmenuDisplay="true" >
                                <ace:menuItem value="Guardar" icon="ui-icon ui-icon-disk" 
                                              action="#{salutemAtenciones.grabar()}" 
                                              rendered="#{salutemAtenciones.formulario.editar}"/>
                                <ace:menuItem value="Eliminar" icon="ui-icon ui-icon-trash"
                                              action="#{salutemAtenciones.remover()}" 
                                              rendered="#{salutemAtenciones.formulario.eliminar}"/>
                                <ace:menuItem value="Cancelar" icon="ui-icon ui-icon-power" 
                                              action="#{salutemAtenciones.cancelar()}"/>                                
                            </ace:menuBar>                           

                            <ace:messages style="white-space: pre-wrap"/>
                        </h:panelGrid>
                    </ace:dialog>
                    <ui:include src="../cuadroHistorial.xhtml"/>
                </ui:define>
                <!-- Fin -->
            </ui:composition>
        </h:form>
    </h:body>

</html>